---
- name: ans_ctrl__orgs_teams.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    controller_host: "{{ controller_host | default('https://controller.example.mil') }}"
    controller_oauthtoken: "{{ controller_oauthtoken | default(lookup('env','TOWER_TOKEN')) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-controller-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

tasks:
  - name: Plan orgs/teams/RBAC
    ansible.builtin.copy:
      dest: "{{ artifacts_dir }}/orgs_teams_plan.json"
      mode: "0644"
      content: "{{ {'organizations': organizations | default([]), 'teams': teams | default([]), 'rbac': rbac | default([])} | to_nice_json }}"

  - name: Create organizations
    when: apply_changes | bool
    loop: "{{ organizations | default([]) }}"
    loop_control: { label: "{{ item.name }}" }
    ansible.controller.organization:
      controller_host: "{{ controller_host }}"
      controller_oauthtoken: "{{ controller_oauthtoken }}"
      validate_certs: "{{ validate_certs }}"
      name: "{{ item.name }}"
      description: "{{ item.description | default('') }}"
      state: present

  - name: Create teams
    when: apply_changes | bool
    loop: "{{ teams | default([]) }}"
    loop_control: { label: "{{ item.name }}" }
    ansible.controller.team:
      controller_host: "{{ controller_host }}"
      controller_oauthtoken: "{{ controller_oauthtoken }}"
      validate_certs: "{{ validate_certs }}"
      name: "{{ item.name }}"
      organization: "{{ item.organization }}"
      description: "{{ item.description | default('') }}"
      state: present

  - name: Apply RBAC (team ↔ roles on objects)
    when: apply_changes | bool
    loop: "{{ rbac | default([]) }}"
    loop_control: { label: "{{ item.team }} → {{ item.role }} on {{ item.object_type }} {{ item.object_name }}" }
    ansible.controller.role:
      controller_host: "{{ controller_host }}"
      controller_oauthtoken: "{{ controller_oauthtoken }}"
      validate_certs: "{{ validate_certs }}"
      team: "{{ item.team | default(omit) }}"
      user: "{{ item.user | default(omit) }}"
      role: "{{ item.role }}"
      target_team: "{{ item.target_team | default(omit) }}"
      target_organization: "{{ (item.object_type == 'organization') | ternary(item.object_name, omit) }}"
      target_project: "{{ (item.object_type == 'project') | ternary(item.object_name, omit) }}"
      target_inventory: "{{ (item.object_type == 'inventory') | ternary(item.object_name, omit) }}"
      target_credential: "{{ (item.object_type == 'credential') | ternary(item.object_name, omit) }}"
      target_job_template: "{{ (item.object_type == 'job_template') | ternary(item.object_name, omit) }}"
      state: present
