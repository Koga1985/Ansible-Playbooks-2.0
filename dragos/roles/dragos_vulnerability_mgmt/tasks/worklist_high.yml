
---
- name: Source findings (from previous step)
  ansible.builtin.set_fact:
    _vf_json: "{{ lookup('ansible.builtin.file', artifacts_dir + '/vuln_findings.json') | from_json }}"

- name: Compute items list
  ansible.builtin.set_fact:
    _vf_items: "{{ (_vf_json.items if _vf_json.items is defined else _vf_json.data | default([])) }}"

- name: Save remediation CSV (>= risk_threshold)
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/vuln_worklist_high.csv"
    mode: "0644"
    content: |
      id,asset,risk,owner,action
      {% for v in _vf_items if (v.risk | default(0)) | float >= (risk_threshold | float) %}
      {{ v.id | default('') }},{{ (v.asset.hostname or v.asset.ip) | default('') }},{{ v.risk | default('') }},{{ v.owner | default('') }},remediate
      {% endfor %}
