
---
- name: Read worklist CSV
  ansible.builtin.set_fact:
    _work_lines: "{{ lookup('ansible.builtin.file', artifacts_dir + '/vuln_worklist_high.csv') | splitlines | list }}"

- name: Create tickets in ServiceNow
  when: itsm.provider | lower == 'servicenow'
  ansible.builtin.uri:
    url: "{{ itsm.url }}/api/now/table/{{ itsm.table | default('incident') }}"
    method: POST
    headers: { Authorization: "Bearer {{ itsm.token }}", Content-Type: "application/json" }
    body_format: json
    body:
      short_description: "Dragos vuln {{ item.split(',')[0] }} on {{ item.split(',')[1] }}"
      severity: "2"
      description: "Risk={{ item.split(',')[2] }} Owner={{ item.split(',')[3] }}"
    status_code: [200,201]
  loop: "{{ _work_lines[1:] }}"
  loop_control: { label: "{{ item.split(',')[0] }}" }

- name: Create tickets in Jira
  when: itsm.provider | lower == 'jira'
  ansible.builtin.uri:
    url: "{{ itsm.jira_url }}/rest/api/2/issue"
    method: POST
    headers: { Authorization: "Bearer {{ itsm.jira_token }}", Content-Type: "application/json" }
    body_format: json
    body:
      fields:
        project: { key: "{{ itsm.jira_project }}" }
        summary: "Remediate vuln {{ item.split(',')[0] }} on {{ item.split(',')[1] }}"
        issuetype: { name: "Task" }
        labels: [ "dragos", "vulnerability" ]
        description: "Risk={{ item.split(',')[2] | default('') }} Owner={{ item.split(',')[3] | default('') }}"
    status_code: [200,201]
  loop: "{{ _work_lines[1:] }}"
  loop_control: { label: "{{ item.split(',')[0] }}" }
