---
- name: Ensure artifacts dir
  ansible.builtin.file: { path: "{{ artifacts_dir }}", state: directory, mode: "0755" }

- name: Export alerts
  ansible.builtin.uri:
    url: "{{ claroty.base_url }}/v1/alerts/search"
    method: POST
    headers: { Authorization: "Bearer {{ claroty.token }}", Content-Type: "application/json" }
    body_format: json
    body: "{{ alerts_filter }}"
    status_code: 200
    return_content: true
    validate_certs: "{{ claroty.verify_ssl | default(true) }}"
  register: alerts

- name: Write alerts CSV
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/{{ alerts_csv }}"
    mode: "0644"
    content: |
      id,severity,category,asset,site,detected_at,status
      {% for a in alerts.json.items | default([]) %}
      {{ a.id | default('') }},{{ a.severity | default('') }},{{ a.category | default('') }},
      {{ a.asset.name | default('') }},{{ a.asset.site.name | default('') }},
      {{ a.detectedAt | default('') }},{{ a.status | default('') }}
      {% endfor %}

- name: Export access logs
  ansible.builtin.uri:
    url: "{{ claroty.base_url }}/v1/secure-access/logs/search"
    method: POST
    headers: { Authorization: "Bearer {{ claroty.token }}", Content-Type: "application/json" }
    body_format: json
    body: "{{ access_logs_filter }}"
    status_code: 200
    return_content: true
    validate_certs: "{{ claroty.verify_ssl | default(true) }}"
  register: access

- name: Write access CSV
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/{{ access_csv }}"
    mode: "0644"
    content: |
      datetime,user,vendor,asset,site,action,result,reason,session_id
      {% for L in access.json.items | default([]) %}
      {{ L.timestamp | default('') }},{{ L.user.email | default('') }},{{ L.user.vendor | default('') }},
      {{ L.asset.name | default('') }},{{ L.asset.site.name | default('') }},
      {{ L.action | default('') }},{{ L.result | default('') }},{{ L.reason | default('') }},
      {{ L.sessionId | default('') }}
      {% endfor %}

- name: Export changes (placeholder endpoint)
  ansible.builtin.uri:
    url: "{{ claroty.base_url }}/v1/changes/search"
    method: POST
    headers: { Authorization: "Bearer {{ claroty.token }}", Content-Type: "application/json" }
    body_format: json
    body: "{{ changes_filter }}"
    status_code: 200
    return_content: true
    validate_certs: "{{ claroty.verify_ssl | default(true) }}"
  register: changes

- name: Write changes CSV
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/{{ changes_csv }}"
    mode: "0644"
    content: |
      datetime,actor,entity,action,details
      {% for C in changes.json.items | default([]) %}
      {{ C.timestamp | default('') }},{{ C.actor | default('') }},{{ C.entity | default('') }},
      {{ C.action | default('') }},{{ (C.details | default('')) | replace('\n',' ') | replace(',',' ') }}
      {% endfor %}
