---
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/ot-artifacts') }}"
    state: directory
    mode: "0755"

- name: Offload backups to secure remote (optional)
  when: offload is defined and offload.url is defined
  ansible.builtin.uri:
    url: "{{ offload.url }}"
    method: POST
    headers: "{{ offload.headers | default({}) }}"
    body_format: json
    body:
      device: "{{ inventory_hostname }}"
      content_b64: "{{ lookup('file', artifacts_dir + '/network_backup_' + inventory_hostname + '.cfg') | b64encode }}"
    status_code: 200,201,202,204
